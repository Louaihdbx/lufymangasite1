<script>
  const zoomLevelDisplay = document.getElementById('zoomLevel');
  const images = document.querySelectorAll('.chapter-pages img');
  let zoom = 1;

  // ====== تحديث الزوم مع الحفاظ على الموضع الحقيقي ======
  function updateZoom(keepPosition = true) {
    let ratio = 0;
    if (keepPosition) {
      const currentScroll = window.scrollY;
      ratio = currentScroll / (document.body.scrollHeight - window.innerHeight);
    }

    images.forEach(img => img.style.width = `${90 * zoom}%`);
    zoomLevelDisplay.textContent = `${Math.round(zoom * 100)}%`;

    if (keepPosition) {
      const newScroll = ratio * (document.body.scrollHeight - window.innerHeight);
      window.scrollTo({ top: newScroll });
    }
  }

  // ====== أزرار الزوم ======
  document.getElementById('zoomIn').onclick = () => {
    zoom = Math.min(2, zoom + 0.1);
    updateZoom();
  };
  document.getElementById('zoomOut').onclick = () => {
    zoom = Math.max(0.4, zoom - 0.1);
    updateZoom();
  };
  document.getElementById('resetZoom').onclick = () => {
    zoom = 1;
    updateZoom();
  };

  // ====== تمرير ناعم مخصص ======
  function smoothScrollTo(targetY, duration = 800) {
    const startY = window.scrollY;
    const diff = targetY - startY;
    let start;
    function step(timestamp) {
      if (!start) start = timestamp;
      const progress = timestamp - start;
      const percent = Math.min(progress / duration, 1);
      window.scrollTo(0, startY + diff * easeInOutQuad(percent));
      if (percent < 1) requestAnimationFrame(step);
    }
    function easeInOutQuad(t) {
      return t < 0.5 ? 2*t*t : -1+(4-2*t)*t;
    }
    requestAnimationFrame(step);
  }

  // ====== الضغط على الصورة ======
  images.forEach((img, i) => {
    img.addEventListener('click', () => {
      const next = images[i + 1];
      if (next) {
        const nextY = next.getBoundingClientRect().top + window.scrollY - 30;
        smoothScrollTo(nextY, 700);
      }
    });
  });

  // ====== الانتقال لأول وآخر صفحة ======
  document.getElementById('firstPageBtn').onclick = e => {
    e.preventDefault();
    smoothScrollTo(0, 1000);
  };
  document.getElementById('lastPageBtn').onclick = e => {
    e.preventDefault();
    smoothScrollTo(document.body.scrollHeight, 1000);
  };
</script>
